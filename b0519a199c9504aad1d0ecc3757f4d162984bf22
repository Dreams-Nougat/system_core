Revision: b0519a199c9504aad1d0ecc3757f4d162984bf22
Patch-set: 1
File: adb/adb.c

937
Tue Jan 08 16:24:30 2013 +0000
Author: David Turner <1000411@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: N5iLeytg
Bytes: 390
I'd recommend rephrasing this to better explain the problem at hand, i.e. the fact that when the adb command is launched from a Python script, stdout/stderr are both inheritable by default, which creates problem, like the fact that the caller will hang when trying to read the command's output even if the client has completed running.

Apart from that, I don't see a problem with the code.

937
Tue Jan 08 16:30:39 2013 +0000
Author: Ray Donnelly <1012093@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: N5iLeytg
UUID: N5qKXOvg
Bytes: 219
The reason I didn't mention Python specifically is because I also run into the same issue with Necessitas Qt Creator, and the WinGDB guys also appear to run into it too, so IMHO the problem is just a general bug in adb.

937
Tue Jan 08 18:00:26 2013 +0000
Author: David Turner <1000411@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: N5qKXOvg
UUID: N5sVEUEw
Bytes: 1225
Yes, it is a bug in adb, no ambiguity here, but it's really subtle, so it'd be nice to have a better description of the problem, it's not really Python specific as you mention, i.e. something like:

"""
Some programs want to launch an adb command and collect its output by calling CreateProcess with inheritable stdout/stderr handles, then using read() to get its output. When this happens, the stdout/stderr handles passed to the adb client process will also be inheritable.

When starting the adb server here, care must be taken to reset them to non-inheritable.

Otherwise, something bad happens: even if the adb command completes, the calling process is stuck while read()-ing from the stdout/stderr descriptors, because they're connected to corresponding handles in the adb server process (even if the latter never uses/writes to them).
"""

The PROC_THREAD_ATTRIBUTE_HANDLE_LIST isn't directly related to the problem, and not needed in this specific case because I don't think there are multiple threads being used in the adb client process (at least when reaching this code). It's probably better to avoid mentioning it, or add a note like "ideally, use PROC_THREAD_ATTRIBUTE_HANDLE_LIST if running on Vista or higher"

937
Tue Jan 08 18:03:56 2013 +0000
Author: Ray Donnelly <1012093@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: N5sVEUEw
UUID: N5mU.HLw
Bytes: 129
I'll use exactly that text and remove all mention of PROC_THREAD_ATTRIBUTE_HANDLE_LIST as adb.exe needs to work pre-Vista anyway.

