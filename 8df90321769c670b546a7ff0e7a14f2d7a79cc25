Revision: 8df90321769c670b546a7ff0e7a14f2d7a79cc25
Patch-set: 1
File: adb/sysdeps_win32.cpp

462
Mon Aug 03 21:03:59 2015 +0000
Author: Elliott Hughes <1003224@85c56323-6fa9-3386-8a01-6480fb634889>
UUID: ca157084_052eb2c5
Bytes: 100
do we still need the special cases? or should we just let SystemErrorCodeToString handle everything?

462
Mon Aug 03 21:37:48 2015 +0000
Author: Spencer Low <1065256@85c56323-6fa9-3386-8a01-6480fb634889>
Parent: ca157084_052eb2c5
UUID: 4acfc072_41a35286
Bytes: 1503
The reason we need the switch is to map Win32 error codes to errno codes, so that the caller can give a better error message. For example, sync_recv() calls adb_creat() and upon failure, it calls strerror(errno). So we can't just map all errors to EINVAL.

If you're asking if we can specifically kill the case ERROR_FILE_NOT_FOUND, we could kill it, but then the D() tracing would say "unknown error" when it really isn't. Maybe this doesn't matter and the D() trace could just be "mapping win32 error code x to errno y" like what I did to socket_set_errno()?

Some alternative ideas that I've bounced around:

1. Call the undocumented C Runtime API _dosmaperr() to map from Win32 error codes to errno codes. I don't really want to do something this gross. The gain isn't big enough to make such a risky change.

2. Implement adb_creat() (and related APIs) out of fopen(), which will indirectly call _dosmaperr() to map the error codes. This would work, but seems kind of a big change to make with not enough benefits (and unknown downsides to consider).

3. Make adb_creat() return a std::string* error like network_*. Frankly, I can accept making the socket stuff return an error string, but I don't know if you really want to go crazy and make more APIs return a string. IMO, it isn't a worth it change to make, unless we really think file APIs are failing a lot on end-user machines. (Winsock is kind of different since it has very broad error codes and adb does a lot of network stuff).

Thoughts?

