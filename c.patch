From 8ece3aacd2b510c57a4b8a9ec46160454762d8b9 Mon Sep 17 00:00:00 2001
From: ghsr <ghsr92@yandex.ru>
Date: Tue, 27 Sep 2016 03:09:17 +0600
Subject: [PATCH 5/5] Revert "init/builtins.cpp: Switch to finit_module"

This reverts commit f2049163a4ce602dffaa41a747ee5675a0d82752.
---
 init/builtins.cpp | 18 ++++++++----------
 1 file changed, 8 insertions(+), 10 deletions(-)

diff --git a/init/builtins.cpp b/init/builtins.cpp
index 339b198..5569498 100755
--- a/init/builtins.cpp
+++ b/init/builtins.cpp
@@ -29,7 +29,6 @@
 #include <sys/socket.h>
 #include <sys/mount.h>
 #include <sys/resource.h>
-#include <sys/syscall.h>
 #include <sys/time.h>
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -69,20 +68,19 @@ using android::base::StringPrintf;
 #define UNMOUNT_CHECK_MS 5000
 #define UNMOUNT_CHECK_TIMES 10
 
+// System call provided by bionic but not in any header file.
+extern "C" int init_module(void *, unsigned long, const char *);
+
 static const int kTerminateServiceDelayMicroSeconds = 50000;
 
 static int insmod(const char *filename, const char *options) {
-    int fd = open(filename, O_RDONLY | O_NOFOLLOW | O_CLOEXEC);
-    if (fd == -1) {
-        ERROR("insmod: open(\"%s\") failed: %s", filename, strerror(errno));
+    std::string module;
+    if (!read_file(filename, &module)) {
         return -1;
     }
-    int rc = syscall(__NR_finit_module, fd, options, 0);
-    if (rc == -1) {
-        ERROR("finit_module for \"%s\" failed: %s", filename, strerror(errno));
-    }
-    close(fd);
-    return rc;
+
+    // TODO: use finit_module for >= 3.8 kernels.
+    return init_module(&module[0], module.size(), options);
 }
 
 static int __ifupdown(const char *interface, int up) {
-- 
2.9.3
